<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <title>Hologram video (Pepper‚Äôs Ghost)</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    :root{
      --bg:#000;
      --fg:#eaeaea;
      --muted:#a9a9a9;
      --card:#111;
      --border:#222;
      --accent:#7dd3fc;

      /* velikost kompozice */
      --size: min(72vmin, 620px);

      /* mezera uprost≈ôed (pro ≈°piƒçku pyramidy) */
      --gap: 10px;

      /* zoom vide√≠ (1.0‚Äì3.0) */
      --zoom: 1;

      /* velikost jednoho videa (ƒçtverec) */
      --videoSize: calc((var(--size) - var(--gap) * 2) / 2);
    }

    html,body{height:100%;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .wrap{
      display:grid;
      grid-template-rows:auto 1fr auto;
      min-height:100%;
      padding: max(14px, env(safe-area-inset-top)) 14px max(14px, env(safe-area-inset-bottom));
      box-sizing:border-box;
      gap: 12px;
    }

    header{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    h1{
      font-size:18px;
      margin:0;
      font-weight:650;
      letter-spacing:.2px;
    }

    .panel{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }

    .btn, .file{
      background:var(--card);
      border:1px solid var(--border);
      color:var(--fg);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      text-decoration:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ border-color:#2b2b2b; }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ border-color: #2a2a2a; box-shadow: 0 0 0 1px rgba(125,211,252,.2) inset; }
    .btn.primary:hover{ border-color: rgba(125,211,252,.6); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; transform:none; }

    input[type="file"]{ display:none; }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:center;
    }

    .chip{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 10px;
      color:var(--muted);
      font-size:13px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .chip strong{ color:var(--fg); font-weight:650; }

    /* Hologram stage */
    .stageWrap{
      display:grid;
      place-items:center;
      width:100%;
    }
    .stage{
      width:var(--size);
      height:var(--size);
      position:relative;
      background:#000;
      border:1px solid #111;
      border-radius:18px;
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      touch-action: manipulation; /* zlep≈°√≠ dvojklik na mobilech */
    }

    .guide{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:.25;
    }
    .guide::before, .guide::after{
      content:"";
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      background:#fff;
      opacity:.18;
    }
    .guide::before{ width:2px; height:100%; }
    .guide::after{ height:2px; width:100%; }

    /* 4 videa rozm√≠stƒõn√° do k≈ô√≠≈æe */
    .v{
      position:absolute;
      width: var(--videoSize);
      height: var(--videoSize);
      object-fit: cover; /* vypln√≠ ƒçtverec, o≈ôe≈æe */
      background:#000;
      filter: saturate(1.05) contrast(1.05);
      transform-origin:center;
    }

    /* st≈ôedov√Ω ‚Äúmrtv√Ω‚Äù ƒçtverec (kam se op√≠r√° ≈°piƒçka pyramidy) */
    .centerHole{
      position:absolute;
      width: calc(var(--gap) * 2);
      height: calc(var(--gap) * 2);
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      background:#000;
      border-radius:10px;
    }

    /* pozice */
    .top    { left:50%; top: calc(50% - var(--gap) - var(--videoSize)); }
    .bottom { left:50%; top: calc(50% + var(--gap)); }
    .left   { left: calc(50% - var(--gap) - var(--videoSize)); top:50%; }
    .right  { left: calc(50% + var(--gap)); top:50%; }

    /* rotace pro Pepper‚Äôs Ghost (standardn√≠ ‚Äúpyramida na telefonu‚Äù) + ZOOM */
    .mode-standard .top    { transform:translateX(-50%) rotate(180deg) scale(var(--zoom)); }
    .mode-standard .bottom { transform:translateX(-50%) rotate(0deg)   scale(var(--zoom)); }
    .mode-standard .left   { transform:translateY(-50%) rotate(90deg)  scale(var(--zoom)); }
    .mode-standard .right  { transform:translateY(-50%) rotate(-90deg) scale(var(--zoom)); }

    /* alternativn√≠ rotace + ZOOM */
    .mode-invert .top    { transform:translateX(-50%) rotate(0deg)   scale(var(--zoom)); }
    .mode-invert .bottom { transform:translateX(-50%) rotate(180deg) scale(var(--zoom)); }
    .mode-invert .left   { transform:translateY(-50%) rotate(-90deg) scale(var(--zoom)); }
    .mode-invert .right  { transform:translateY(-50%) rotate(90deg)  scale(var(--zoom)); }

    footer{
      color:var(--muted);
      font-size:12px;
      text-align:center;
    }

    /* Fullscreen: a≈• se stage rozt√°hne */
    :fullscreen .wrap,
    :-webkit-full-screen .wrap{
      padding: 0;
      grid-template-rows:auto 1fr auto;
    }
:fullscreen .stage,
:-webkit-full-screen .stage{
  width:100vw !important;
  height:100vh !important;
      border-radius:0;
      border:none;
      box-shadow:none;
    }

    /* --- ƒåIST√ù HOLOGRAM RE≈ΩIM (jen video, bez ovl√°d√°n√≠) --- */
    body.pureMode header,
    body.pureMode .controls,
    body.pureMode footer{
      display:none !important;
    }
    body.pureMode .wrap{
      padding:0 !important;
      grid-template-rows:1fr !important;
      gap:0 !important;
    }
    body.pureMode .stageWrap{
      place-items:stretch !important;
    }
    body.pureMode .stage{
      width:100vw !important;
      height:100vh !important;
      border:none !important;
      border-radius:0 !important;
      box-shadow:none !important;
    }
    body.pureMode{
  --size: 100vmin !important;
}
    body.pureMode .guide{ opacity:0; } /* v ƒçist√©m re≈æimu bez k≈ô√≠≈æe */
  </style>
</head>

<body>
  <div class="wrap" id="app">
    <header>
      <h1>Hologram video (Pepper‚Äôs Ghost) ‚Äì 4√ó zrcadlen√≠</h1>
      <div class="panel">
        <label class="file btn primary" for="fileInput" title="Nahraj video">
          üìπ Nahr√°t video
        </label>
        <input id="fileInput" type="file" accept="video/*" />
        <button class="btn" id="demoBtn" title="Naƒç√≠st demo (pokud existuje soubor demo.mp4 vedle indexu)">
          ü¶ã Demo
        </button>
        <button class="btn" id="fsBtn" title="Cel√° obrazovka" disabled>
          ‚õ∂ Fullscreen
        </button>
      </div>
    </header>

    <div class="controls">
      <div class="chip">
        Re≈æim: <strong id="modeLabel">Standard</strong>
      </div>
      <button class="btn" id="modeBtn" disabled>üîÑ P≈ôepnout re≈æim</button>

      <div class="chip">
        Velikost: <strong id="sizeLabel">72vmin</strong>
      </div>
      <input id="sizeRange" type="range" min="40" max="95" value="72" style="width:220px" disabled />

      <div class="chip">
        St≈ôed (gap): <strong id="gapLabel">10px</strong>
      </div>
      <!-- gap a≈æ 120 px (60+ bez probl√©mu) -->
      <input id="gapRange" type="range" min="0" max="120" value="10" style="width:200px" disabled />

      <div class="chip">
        Zoom: <strong id="zoomLabel">1.0√ó</strong>
      </div>
      <input id="zoomRange" type="range" min="1" max="3" step="0.1" value="1" style="width:200px" disabled />

      <button class="btn" id="playBtn" disabled>‚ñ∂Ô∏é / ‚è∏Ô∏é</button>
      <button class="btn" id="muteBtn" disabled>üîá / üîä</button>
      <button class="btn" id="loopBtn" disabled>üîÅ Loop: ON</button>
    </div>

    <main class="stageWrap">
      <div class="stage mode-standard" id="stage" title="Dvojklik: ƒçist√Ω fullscreen re≈æim / zpƒõt">
        <div class="guide"></div>
        <div class="centerHole"></div>

        <!-- master video (pro captureStream, skryt√©) -->
        <video id="vMaster" playsinline style="position:absolute;width:1px;height:1px;left:-9999px;top:-9999px;"></video>

        <!-- 4 synchronizovan√° videa -->
        <video class="v top"    id="vTop"    playsinline></video>
        <video class="v bottom" id="vBottom" playsinline></video>
        <video class="v left"   id="vLeft"   playsinline></video>
        <video class="v right"  id="vRight"  playsinline></video>
      </div>
    </main>

    <footer>
      Tip: nejlep≈°√≠ efekt je u vide√≠ s <strong>ƒçern√Ωm pozad√≠m</strong>. Dvojklik kdekoliv p≈ôepne ƒçist√Ω fullscreen hologram.
    </footer>
  </div>

  <script>
    // --- PWA registrace service workeru ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(() => {});
      });
    }

    const els = {
      fileInput: document.getElementById('fileInput'),
      demoBtn: document.getElementById('demoBtn'),
      fsBtn: document.getElementById('fsBtn'),
      modeBtn: document.getElementById('modeBtn'),
      modeLabel: document.getElementById('modeLabel'),
      stage: document.getElementById('stage'),
      sizeRange: document.getElementById('sizeRange'),
      sizeLabel: document.getElementById('sizeLabel'),
      gapRange: document.getElementById('gapRange'),
      gapLabel: document.getElementById('gapLabel'),
      zoomRange: document.getElementById('zoomRange'),
      zoomLabel: document.getElementById('zoomLabel'),
      playBtn: document.getElementById('playBtn'),
      muteBtn: document.getElementById('muteBtn'),
      loopBtn: document.getElementById('loopBtn'),
      vids: {
        master: document.getElementById('vMaster'),
        top: document.getElementById('vTop'),
        bottom: document.getElementById('vBottom'),
        left: document.getElementById('vLeft'),
        right: document.getElementById('vRight'),
      }
    };

    let currentURL = null;

    let streamMode = false;
    let lastStream = null;

    // nastaven√≠ ulo≈æen√© v localStorage
    let mode = localStorage.getItem('holoMode') || 'standard'; // 'standard' | 'invert'
    let loopOn = (localStorage.getItem('holoLoop') ?? '1') === '1';
    let muted = (localStorage.getItem('holoMuted') ?? '1') === '1'; // default muted = ON (autoplay friendly)
    let pure = false; // ƒçist√Ω re≈æim fullscreen

    function setEnabled(enabled){
      els.fsBtn.disabled = !enabled;
      els.modeBtn.disabled = !enabled;
      els.sizeRange.disabled = !enabled;
      els.gapRange.disabled = !enabled;
      els.zoomRange.disabled = !enabled;
      els.playBtn.disabled = !enabled;
      els.muteBtn.disabled = !enabled;
      els.loopBtn.disabled = !enabled;
    }

    function setMode(newMode){
      mode = newMode;
      els.stage.classList.toggle('mode-standard', mode === 'standard');
      els.stage.classList.toggle('mode-invert', mode === 'invert');
      els.modeLabel.textContent = (mode === 'standard') ? 'Standard' : 'Invert';
      localStorage.setItem('holoMode', mode);
    }

    function setLoop(on){
      loopOn = on;
      localStorage.setItem('holoLoop', loopOn ? '1' : '0');
      els.loopBtn.textContent = 'üîÅ Loop: ' + (loopOn ? 'ON' : 'OFF');

      els.vids.master.loop = loopOn;
      if (!streamMode){
        for (const v of [els.vids.top, els.vids.bottom, els.vids.left, els.vids.right]) v.loop = loopOn;
      }
    }
function setMuted(on){
      muted = on;
      localStorage.setItem('holoMuted', muted ? '1' : '0');
      els.muteBtn.textContent = muted ? 'üîá / üîä' : 'üîä / üîá';

      // master ≈ô√≠d√≠ zvuk
      els.vids.master.muted = muted;

      // kopie v re≈æimu stream jsou v≈ædy ztlumen√©
      if (!streamMode){
        for (const v of [els.vids.top, els.vids.bottom, els.vids.left, els.vids.right]) v.muted = muted;
      } else {
        for (const v of [els.vids.top, els.vids.bottom, els.vids.left, els.vids.right]) v.muted = true;
      }
    }
function applySize(vmin){
      document.documentElement.style.setProperty('--size', `min(${vmin}vmin, 620px)`);
      els.sizeLabel.textContent = `${vmin}vmin`;
      localStorage.setItem('holoSize', String(vmin));
    }

    function applyGap(px){
      document.documentElement.style.setProperty('--gap', `${px}px`);
      els.gapLabel.textContent = `${px}px`;
      localStorage.setItem('holoGap', String(px));
    }

    function applyZoom(z){
      document.documentElement.style.setProperty('--zoom', z);
      els.zoomLabel.textContent = z.toFixed(1) + "√ó";
      localStorage.setItem('holoZoom', String(z));
    }

    // synchronizace p≈ôehr√°v√°n√≠ a ƒçasu (jednoduch√°, robustn√≠)
    let syncTimer = null;
    function startSync(){
      stopSync();
      syncTimer = setInterval(() => {
        const ref = els.vids.bottom;
        if (!ref || ref.readyState < 2 || ref.seeking) return;

        const t = ref.currentTime;

        for (const v of Object.values(els.vids)) {
          if (v === ref) continue;
          if (v.readyState < 2 || v.seeking) continue;

          const dt = v.currentTime - t;
          const adt = Math.abs(dt);

          // Kdy≈æ ujel hodnƒõ, udƒõlej jen obƒçasn√Ω skok (jinak by to cukalo po≈ô√°d)
          if (adt > 0.6) {
            v.currentTime = t;
            v.playbackRate = 1.0;
            continue;
          }

          // Jemn√© dorovn√°n√≠ bez skok≈Ø v ƒçase
          if (adt > 0.10) {
            v.playbackRate = (dt > 0) ? 0.96 : 1.04;
          } else {
            v.playbackRate = 1.0;
          }

          if (ref.paused && !v.paused) v.pause();
          if (!ref.paused && v.paused) v.play().catch(()=>{});
        }
      }, 400);
    }
    function stopSync(){
      if (syncTimer) clearInterval(syncTimer);
      syncTimer = null;
      // Vra≈• rychlost zpƒõt na norm√°l (kdy≈æ se sync vypne nebo restartuje)
      for (const v of Object.values(els.vids)) v.playbackRate = 1.0;
    }

    async function loadVideoFromURL(url){
      // uvolnit star√Ω blob
      if (currentURL && currentURL.startsWith('blob:')) URL.revokeObjectURL(currentURL);
      currentURL = url;

      // zru≈° p≈ô√≠padn√Ω star√Ω stream
      streamMode = false;
      lastStream = null;
      for (const v of [els.vids.top, els.vids.bottom, els.vids.left, els.vids.right]) {
        try { v.srcObject = null; } catch(e) {}
      }

      const master = els.vids.master;

      // nastav master
      master.src = url;
      master.playsInline = true;
      master.preload = 'auto';
      master.loop = loopOn;
      master.muted = muted;

      // poƒçkat na metadata
      await new Promise((resolve, reject) => {
        const onOk = () => { cleanup(); resolve(); };
        const onErr = () => { cleanup(); reject(new Error('Nelze naƒç√≠st video')); };
        const cleanup = () => {
          master.removeEventListener('loadedmetadata', onOk);
          master.removeEventListener('error', onErr);
        };
        master.addEventListener('loadedmetadata', onOk, { once:true });
        master.addEventListener('error', onErr, { once:true });
      });

      setEnabled(true);

      // pokus o autoplay masteru (na mobilu vƒõt≈°inou jen kdy≈æ je muted)
      try { await master.play(); } catch(e) {}

      // --- Preferovan√Ω re≈æim: captureStream (1√ó dek√≥dov√°n√≠, 4√ó zobrazen√≠) ---
      if (master.captureStream) {
        try{
          lastStream = master.captureStream();
          streamMode = true;

          for (const v of [els.vids.top, els.vids.bottom, els.vids.left, els.vids.right]) {
            v.srcObject = lastStream;
            v.playsInline = true;
            v.preload = 'auto';
            // kopie v≈ædy muted (hlas ≈ô√≠d√≠ master)
            v.muted = true;
            // loop ≈ô√≠d√≠ master
            v.loop = false;
          }

          // rozbƒõhnout kopie
          for (const v of [els.vids.top, els.vids.bottom, els.vids.left, els.vids.right]) {
            try { await v.play(); } catch(e) {}
          }

          // v re≈æimu stream nen√≠ pot≈ôeba sync
          stopSync();
          return;
        }catch(e){
          // captureStream selhalo ‚Üí fallback
          streamMode = false;
          lastStream = null;
          for (const v of [els.vids.top, els.vids.bottom, els.vids.left, els.vids.right]) {
            try { v.srcObject = null; } catch(_) {}
          }
        }
      }

      // --- Fallback: p≈Øvodn√≠ 4√ó <video src> + jemn√° synchronizace ---
      for (const v of [els.vids.top, els.vids.bottom, els.vids.left, els.vids.right]) {
        v.src = url;
        v.playsInline = true;
        v.preload = 'auto';
        v.loop = loopOn;
        v.muted = muted;
      }

      startSync();

      for (const v of [els.vids.top, els.vids.bottom, els.vids.left, els.vids.right]) {
        try { await v.play(); } catch(e) {}
      }
    }


      // poƒçkat na metadata (aspo≈à u jednoho)
      await new Promise((resolve, reject) => {
        const v = els.vids.bottom;
        const onOk = () => { cleanup(); resolve(); };
        const onErr = () => { cleanup(); reject(new Error('Nelze naƒç√≠st video')); };
        const cleanup = () => {
          v.removeEventListener('loadedmetadata', onOk);
          v.removeEventListener('error', onErr);
        };
        v.addEventListener('loadedmetadata', onOk, { once:true });
        v.addEventListener('error', onErr, { once:true });
      });

      setEnabled(true);
      startSync();

      // pokus o autoplay (na mobilu vƒõt≈°inou jen kdy≈æ je muted)
      for (const v of Object.values(els.vids)) {
        try { await v.play(); } catch(e) {}
      }
    }

    // --- ƒåIST√ù FULLSCREEN RE≈ΩIM (dvojklik) ---
    async function enterPureMode(){
      pure = true;
      document.body.classList.add("pureMode");
      if (!document.fullscreenElement){
        try { await document.documentElement.requestFullscreen(); } catch(e) {}
      }
    }

    async function exitPureMode(){
      pure = false;
      document.body.classList.remove("pureMode");
      if (document.fullscreenElement){
        try { await document.exitFullscreen(); } catch(e) {}
      }
    }

    // dvojklik kdekoliv
    document.addEventListener("dblclick", (e) => {
      // Kdy≈æ je≈°tƒõ nen√≠ video naƒçten√©, dvojklik nic nedƒõl√°
      if (els.fsBtn.disabled) return;

      if (pure) exitPureMode();
      else enterPureMode();
    });

    // kdy≈æ u≈æivatel vypne fullscreen jinak (gestem), vra≈• UI
    document.addEventListener("fullscreenchange", () => {
      if (!document.fullscreenElement && pure){
        pure = false;
        document.body.classList.remove("pureMode");
      }
    });

    // --- UI ud√°losti ---
    els.fileInput.addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      try{
        await loadVideoFromURL(url);
      }catch(err){
        alert('Video se nepoda≈ôilo naƒç√≠st.');
      }
    });

    els.demoBtn.addEventListener('click', async () => {
      try{
        await loadVideoFromURL('./demo.mp4');
      }catch(err){
        alert('Demo nen√≠ k dispozici. Nahraj vlastn√≠ video (nebo p≈ôidej demo.mp4 vedle index.html).');
      }
    });

    els.modeBtn.addEventListener('click', () => {
      setMode(mode === 'standard' ? 'invert' : 'standard');
    });

    els.playBtn.addEventListener('click', async () => {
      const master = els.vids.master;
      const ref = streamMode ? master : els.vids.bottom;

      if (ref.paused){
        try{ await master.play(); }catch(e){}
        for (const v of [els.vids.top, els.vids.bottom, els.vids.left, els.vids.right]) { try{ await v.play(); }catch(e){} }
      } else {
        for (const v of [els.vids.top, els.vids.bottom, els.vids.left, els.vids.right]) v.pause();
        master.pause();
      }
    });
els.muteBtn.addEventListener('click', () => setMuted(!muted));
    els.loopBtn.addEventListener('click', () => setLoop(!loopOn));

    els.sizeRange.addEventListener('input', (e) => applySize(Number(e.target.value)));
    els.gapRange.addEventListener('input', (e) => applyGap(Number(e.target.value)));
    els.zoomRange.addEventListener('input', (e) => applyZoom(Number(e.target.value)));

    els.fsBtn.addEventListener('click', async () => {
      // klasick√© tlaƒç√≠tko nech√°v√°me jako alternativu
      if (!document.fullscreenElement){
        try{ await document.documentElement.requestFullscreen(); }catch(e){}
      } else {
        try{ await document.exitFullscreen(); }catch(e){}
      }
    });

    // --- naƒç√≠st ulo≈æen√© nastaven√≠ ---
    setMode(mode);

    const savedSize = Number(localStorage.getItem('holoSize') || 72);
    const savedGap  = Number(localStorage.getItem('holoGap')  || 10);
    const savedZoom = Number(localStorage.getItem('holoZoom') || 1);

    els.sizeRange.value = String(savedSize);
    els.gapRange.value = String(savedGap);
    els.zoomRange.value = String(savedZoom);

    applySize(savedSize);
    applyGap(savedGap);
    applyZoom(savedZoom);

    setLoop(loopOn);
    setMuted(muted);

    setEnabled(false);
  </script>
</body>
</html>
